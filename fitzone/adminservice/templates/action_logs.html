{% extends 'base.html' %}
{% load static %}

{% block title_name %}
FITZONE - Логи действий
{% endblock %}

{% block content %}
<!-- Основной контейнер для частиц -->
<div class="particles-container" id="particles"></div>

<section class="hero-section" style="margin: 100px 40px 80px; min-height: auto; padding-top: 20px;">
    <div class="hero-content">
        <h1 class="hero-title">
            ЛОГИ ДЕЙСТВИЙ ПОЛЬЗОВАТЕЛЕЙ
        </h1>

        <!-- Карточка с фильтрами и поиском -->
        <div class="admin-logs-filters-card">
            <div class="admin-logs-card-header">
                <h2><i class="fas fa-filter"></i> ФИЛЬТРЫ И ПОИСК</h2>
                <span class="admin-logs-total-badge">Всего записей: {{ total_logs }}</span>
            </div>
            
            <form method="get" class="admin-logs-filters-form">
                <div class="admin-logs-filters-grid">
                    <!-- Поле поиска по названию действия -->
                    <div class="admin-logs-filter-group">
                        <label>Поиск по названию:</label>
                        <input type="text" name="search" value="{{ request.GET.search }}" 
                               placeholder="Введите название действия..." class="admin-logs-form-control">
                    </div>

                    <!-- Фильтр по роли пользователя -->
                    <div class="admin-logs-filter-group">
                        <label>Роль пользователя:</label>
                        <select name="role" class="admin-logs-form-control">
                            <option value="">Все роли</option>
                            {% for role in roles %}
                            <option value="{{ role.name }}" {% if request.GET.role == role.name %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Фильтр по конкретному пользователю -->
                    <div class="admin-logs-filter-group">
                        <label>Пользователь:</label>
                        <select name="user" class="admin-logs-form-control">
                            <option value="">Все пользователи</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if request.GET.user == user.id|stringformat:"i" %}selected{% endif %}>
                                {{ user.userprofile.full_name|default:user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Фильтр по типу действия -->
                    <div class="admin-logs-filter-group">
                        <label>Тип действия:</label>
                        <select name="action_type" class="admin-logs-form-control">
                            <option value="">Все типы</option>
                            {% for type_code, type_name in action_types %}
                            <option value="{{ type_code }}" {% if request.GET.action_type == type_code %}selected{% endif %}>
                                {{ type_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Кнопки применения и сброса фильтров -->
                <div class="admin-logs-filter-actions">
                    <button type="submit" class="admin-logs-btn admin-logs-btn-primary">
                        <i class="fas fa-search"></i> Применить фильтры
                    </button>
                    <a href="{% url 'adminservice:action_logs' %}" class="admin-logs-btn admin-logs-btn-secondary">
                        <i class="fas fa-times"></i> Сбросить
                    </a>
                </div>
            </form>
        </div>

        <!-- Основная карточка с таблицей логов -->
        <div class="admin-logs-dashboard-card">
            <div class="admin-logs-card-header">
                <h2><i class="fas fa-list-alt"></i> ЖУРНАЛ ДЕЙСТВИЙ</h2>
                <!-- Элементы управления сортировкой -->
                <div class="admin-logs-sort-controls">
                    <span>Сортировка:</span>
                    <select onchange="location = this.value;" class="admin-logs-sort-select">
                        <option value="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}sort=-actiondate" 
                                {% if request.GET.sort == '-actiondate' or not request.GET.sort %}selected{% endif %}>
                            Сначала новые
                        </option>
                        <option value="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}sort=actiondate" 
                                {% if request.GET.sort == 'actiondate' %}selected{% endif %}>
                            Сначала старые
                        </option>
                        <option value="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}sort=user_full_name" 
                                {% if request.GET.sort == 'user_full_name' %}selected{% endif %}>
                            По пользователю (А-Я)
                        </option>
                        <option value="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}sort=-user_full_name" 
                                {% if request.GET.sort == '-user_full_name' %}selected{% endif %}>
                            По пользователю (Я-А)
                        </option>
                        <option value="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}sort=action_type" 
                                {% if request.GET.sort == 'action_type' %}selected{% endif %}>
                            По типу действия
                        </option>
                    </select>
                </div>
            </div>

            {% if logs %}
            <!-- Контейнер таблицы с логами -->
            <div class="admin-logs-table-container">
                <table class="admin-logs-data-table">
                    <thead>
                        <tr>
                            <th>Дата и время</th>
                            <th>Пользователь</th>
                            <th>Действие</th>
                            <th>Тип действия</th>
                            <th>Объект</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Цикл отображения записей логов -->
                        {% for log in logs %}
                        <tr class="admin-logs-row">
                            <td class="admin-logs-date">
                                <div class="admin-logs-date-time">
                                    <div class="admin-logs-date-text">{{ log.actiondate|date:"d.m.Y" }}</div>
                                    <div class="admin-logs-time-text">{{ log.actiondate|date:"H:i:s" }}</div>
                                </div>
                            </td>
                            <td class="admin-logs-user">
                                {% if log.user_full_name %}
                                    <div class="admin-logs-user-info">
                                        <div class="admin-logs-user-name">{{ log.user_full_name }}</div>
                                        {% if log.user %}
                                        <div class="admin-logs-user-email">{{ log.user.email }}</div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="admin-logs-no-user">Система</span>
                                {% endif %}
                            </td>
                            <td class="admin-logs-action">
                                <div class="admin-logs-action-text">{{ log.action }}</div>
                            </td>
                            <td class="admin-logs-type">
                                <!-- Бейдж с цветовым кодированием типа действия -->
                                <span class="admin-logs-action-badge admin-logs-action-{{ log.action_type|lower }}">
                                    {{ log.get_action_type_display }}
                                </span>
                            </td>
                            <td class="admin-logs-object">
                                {% if log.model_name %}
                                    <div class="admin-logs-object-info">
                                        <span class="admin-logs-model-name">{{ log.model_name }}</span>
                                        {% if log.object_id %}
                                        <span class="admin-logs-object-id">#{{ log.object_id }}</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="admin-logs-no-object">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Пагинация для большого количества записей -->
            {% if logs.has_other_pages %}
            <div class="admin-logs-pagination">
                <div class="admin-logs-pagination-info">
                    Показано {{ logs.start_index }} - {{ logs.end_index }} из {{ total_logs }} записей
                </div>
                <div class="admin-logs-pagination-controls">
                    {% if logs.has_previous %}
                        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page=1" class="admin-logs-pagination-btn admin-logs-pagination-first">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ logs.previous_page_number }}" class="admin-logs-pagination-btn admin-logs-pagination-prev">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    {% endif %}

                    {% for num in logs.paginator.page_range %}
                        {% if logs.number == num %}
                            <span class="admin-logs-pagination-btn admin-logs-pagination-active">{{ num }}</span>
                        {% elif num > logs.number|add:'-3' and num < logs.number|add:'3' %}
                            <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}" class="admin-logs-pagination-btn">{{ num }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if logs.has_next %}
                        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ logs.next_page_number }}" class="admin-logs-pagination-btn admin-logs-pagination-next">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ logs.paginator.num_pages }}" class="admin-logs-pagination-btn admin-logs-pagination-last">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Карточка с визуализацией статистики логов -->
            <div class="admin-logs-dashboard-card">
                <div class="admin-logs-card-header">
                    <h2><i class="fas fa-chart-pie"></i> СТАТИСТИКА ЛОГОВ ПО ТИПАМ</h2>
                    <!-- Управление периодом для статистики -->
                    <div class="admin-logs-chart-controls">
                        <form method="get" id="chartPeriodForm" class="admin-logs-period-form">
                            <div class="period-controls">
                                <span>Период:</span>
                                <select name="chart_period" class="admin-logs-form-control">
                                    <option value="7" {% if request.GET.chart_period == '7' %}selected{% endif %}>7 дней</option>
                                    <option value="30" {% if not request.GET.chart_period or request.GET.chart_period == '30' %}selected{% endif %}>30 дней</option>
                                    <option value="90" {% if request.GET.chart_period == '90' %}selected{% endif %}>90 дней</option>
                                    <option value="365" {% if request.GET.chart_period == '365' %}selected{% endif %}>Год</option>
                                    <option value="all" {% if request.GET.chart_period == 'all' %}selected{% endif %}>Все время</option>
                                </select>
                                <button type="submit" class="admin-logs-btn admin-logs-btn-primary">
                                    <i class="fas fa-chart-pie"></i> Построить
                                </button>
                            </div>
                            
                            <!-- Скрытые поля для сохранения параметров фильтрации -->
                            {% if request.GET.search %}
                                <input type="hidden" name="search" value="{{ request.GET.search }}">
                            {% endif %}
                            {% if request.GET.role %}
                                <input type="hidden" name="role" value="{{ request.GET.role }}">
                            {% endif %}
                            {% if request.GET.user %}
                                <input type="hidden" name="user" value="{{ request.GET.user }}">
                            {% endif %}
                            {% if request.GET.action_type %}
                                <input type="hidden" name="action_type" value="{{ request.GET.action_type }}">
                            {% endif %}
                            {% if request.GET.sort %}
                                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
                            {% endif %}
                            {% if request.GET.page %}
                                <input type="hidden" name="page" value="{{ request.GET.page }}">
                            {% endif %}
                        </form>
                    </div>
                </div>
                
                <!-- Контейнер для круговой диаграммы -->
                <div class="admin-logs-chart-container">
                    <div class="admin-logs-chart-wrapper">
                        <canvas id="logsChart" width="400" height="400"></canvas>
                    </div>
                    <div class="admin-logs-chart-legend" id="chartLegend"></div>
                </div>
                
                <!-- Статистические показатели -->
                <div class="admin-logs-chart-stats">
                    <div class="admin-logs-chart-stat">
                        <span class="admin-logs-stat-value" id="totalLogsCount">0</span>
                        <span class="admin-logs-stat-label">Всего записей</span>
                    </div>
                    <div class="admin-logs-chart-stat">
                        <span class="admin-logs-stat-value" id="mostCommonType">—</span>
                        <span class="admin-logs-stat-label">Самый частый тип</span>
                    </div>
                    <div class="admin-logs-chart-stat">
                        <span class="admin-logs-stat-value" id="leastCommonType">—</span>
                        <span class="admin-logs-stat-label">Самый редкий тип</span>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Состояние при отсутствии записей -->
            <div class="admin-logs-empty-state">
                <i class="fas fa-clipboard-list"></i>
                <h3>Записи не найдены</h3>
                <p>Попробуйте изменить параметры фильтрации</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<style>
/* Основные переменные */
:root {
    --neon-purple: #8b5cf6;
    --neon-purple-dark: #7c3aed;
    --neon-purple-light: #a78bfa;
    --light-bg: #f8fafc;
    --light-card: #ffffff;
    --light-border: #f1f5f9;
    --text-dark: #0f172a;
    --text-gray: #64748b;
    --dark-bg: #0f172a;
    --dark-card: #1e293b;
    --dark-border: #334155;
    --dark-text: #e2e8f0;
    --dark-text-light: #94a3b8;
    --accent-gradient: linear-gradient(135deg, var(--neon-purple), var(--neon-purple-dark));
    --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.08);
    --shadow-large: 0 20px 50px rgba(139, 92, 246, 0.15);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Hero Section */
.hero-section {
    min-height: auto;
    padding: 0 40px;
    margin: 100px 40px 80px !important;
    position: relative;
    z-index: 2;
}

.hero-title {
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 800;
    line-height: 1.1;
    margin-bottom: 3rem;
    background: linear-gradient(135deg, var(--text-dark) 0%, var(--neon-purple) 30%, var(--neon-purple-dark) 70%, var(--text-dark) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 200% 200%;
    animation: gradientFlow 4s ease infinite;
    text-transform: uppercase;
    letter-spacing: -2px;
}

@keyframes gradientFlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

/* Карточка фильтров */
.admin-logs-filters-card {
    background: var(--light-card);
    border-radius: 20px;
    padding: 30px;
    border: 1px solid var(--light-border);
    margin-bottom: 30px;
    box-shadow: var(--shadow-medium);
    position: relative;
    overflow: hidden;
}

.admin-logs-filters-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-gradient);
}

.dark-theme .admin-logs-filters-card {
    background: var(--dark-card);
    border-color: var(--dark-border);
}

.admin-logs-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--light-border);
}

.dark-theme .admin-logs-card-header {
    border-bottom-color: var(--dark-border);
}

.admin-logs-card-header h2 {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
}

.dark-theme .admin-logs-card-header h2 {
    color: var(--dark-text);
}

.admin-logs-card-header h2 i {
    color: var(--neon-purple);
    font-size: 1.2rem;
}

.admin-logs-total-badge {
    background: var(--accent-gradient);
    color: white;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
}

/* Форма фильтров */
.admin-logs-filters-form {
    margin-top: 20px;
}

.admin-logs-filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.admin-logs-filter-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.95rem;
}

.dark-theme .admin-logs-filter-group label {
    color: var(--dark-text);
}

.admin-logs-form-control {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--light-border);
    border-radius: 12px;
    background: var(--light-bg);
    color: var(--text-dark);
    font-size: 0.95rem;
    transition: var(--transition);
}

.dark-theme .admin-logs-form-control {
    background: var(--dark-bg);
    border-color: var(--dark-border);
    color: var(--dark-text);
}

.admin-logs-form-control:focus {
    outline: none;
    border-color: var(--neon-purple);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.admin-logs-filter-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Кнопки */
.admin-logs-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.95rem;
}

.admin-logs-btn-primary {
    background: var(--accent-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
}

.admin-logs-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
}

.admin-logs-btn-secondary {
    background: var(--light-bg);
    color: var(--text-dark);
    border: 1px solid var(--light-border);
}

.dark-theme .admin-logs-btn-secondary {
    background: var(--dark-bg);
    color: var(--dark-text);
    border-color: var(--dark-border);
}

.admin-logs-btn-secondary:hover {
    border-color: var(--neon-purple);
    color: var(--neon-purple);
    transform: translateY(-2px);
}

/* Основная карточка */
.admin-logs-dashboard-card {
    background: var(--light-card);
    border-radius: 20px;
    padding: 30px;
    border: 1px solid var(--light-border);
    margin-bottom: 30px;
    box-shadow: var(--shadow-medium);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.admin-logs-dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-gradient);
}

.dark-theme .admin-logs-dashboard-card {
    background: var(--dark-card);
    border-color: var(--dark-border);
}

.admin-logs-dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-large);
}

/* Сортировка */
.admin-logs-sort-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.95rem;
}

.admin-logs-sort-select {
    padding: 8px 12px;
    border: 1px solid var(--light-border);
    border-radius: 8px;
    background: var(--light-bg);
    color: var(--text-dark);
    transition: var(--transition);
}

.dark-theme .admin-logs-sort-select {
    background: var(--dark-bg);
    border-color: var(--dark-border);
    color: var(--dark-text);
}

.admin-logs-sort-select:focus {
    outline: none;
    border-color: var(--neon-purple);
}

/* Таблица */
.admin-logs-table-container {
    overflow-x: auto;
    margin-bottom: 25px;
    border-radius: 12px;
    border: 1px solid var(--light-border);
}

.dark-theme .admin-logs-table-container {
    border-color: var(--dark-border);
}

.admin-logs-data-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.admin-logs-data-table th {
    background: var(--light-bg);
    padding: 20px;
    text-align: left;
    font-weight: 700;
    color: var(--text-dark);
    border-bottom: 1px solid var(--light-border);
    font-size: 0.95rem;
    white-space: nowrap;
}

.dark-theme .admin-logs-data-table th {
    background: var(--dark-bg);
    color: var(--dark-text);
    border-bottom-color: var(--dark-border);
}

.admin-logs-data-table td {
    padding: 20px;
    border-bottom: 1px solid var(--light-border);
    vertical-align: top;
}

.dark-theme .admin-logs-data-table td {
    border-bottom-color: var(--dark-border);
}

.admin-logs-row:hover {
    background: var(--light-bg);
    transform: scale(1.01);
    transition: var(--transition);
}

.dark-theme .admin-logs-row:hover {
    background: var(--dark-bg);
}

/* Стили для ячеек таблицы */
.admin-logs-date .admin-logs-date-time {
    line-height: 1.2;
}

.admin-logs-date .admin-logs-date-text {
    font-weight: 700;
    color: var(--text-dark);
    font-size: 0.95rem;
}

.admin-logs-date .admin-logs-time-text {
    color: var(--text-gray);
    font-size: 0.85rem;
}

.dark-theme .admin-logs-date .admin-logs-date-text {
    color: var(--dark-text);
}

.dark-theme .admin-logs-date .admin-logs-time-text {
    color: var(--dark-text-light);
}

.admin-logs-user .admin-logs-user-info {
    line-height: 1.2;
}

.admin-logs-user .admin-logs-user-name {
    font-weight: 700;
    color: var(--text-dark);
    font-size: 0.95rem;
}

.admin-logs-user .admin-logs-user-email {
    color: var(--text-gray);
    font-size: 0.85rem;
}

.dark-theme .admin-logs-user .admin-logs-user-name {
    color: var(--dark-text);
}

.dark-theme .admin-logs-user .admin-logs-user-email {
    color: var(--dark-text-light);
}

.admin-logs-no-user, .admin-logs-no-object {
    color: var(--text-gray);
    font-style: italic;
}

.admin-logs-action .admin-logs-action-text {
    color: var(--text-dark);
    font-size: 0.95rem;
    line-height: 1.4;
}

.dark-theme .admin-logs-action .admin-logs-action-text {
    color: var(--dark-text);
}

/* Бейджи типов действий */
.admin-logs-action-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    border: 1px solid transparent;
}

.admin-logs-action-create {
    background: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
    border-color: rgba(46, 204, 113, 0.3);
}

.admin-logs-action-update {
    background: rgba(52, 152, 219, 0.15);
    color: #3498db;
    border-color: rgba(52, 152, 219, 0.3);
}

.admin-logs-action-delete {
    background: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
    border-color: rgba(231, 76, 60, 0.3);
}

.admin-logs-action-login {
    background: rgba(155, 89, 182, 0.15);
    color: #9b59b6;
    border-color: rgba(155, 89, 182, 0.3);
}

.admin-logs-action-logout {
    background: rgba(149, 165, 166, 0.15);
    color: #95a5a6;
    border-color: rgba(149, 165, 166, 0.3);
}

.admin-logs-action-system {
    background: rgba(243, 156, 18, 0.15);
    color: #f39c12;
    border-color: rgba(243, 156, 18, 0.3);
}

.admin-logs-object .admin-logs-object-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.admin-logs-model-name {
    color: var(--text-dark);
    font-size: 0.95rem;
}

.admin-logs-object-id {
    color: var(--text-gray);
    font-size: 0.8rem;
    background: var(--light-bg);
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 600;
}

.dark-theme .admin-logs-model-name {
    color: var(--dark-text);
}

.dark-theme .admin-logs-object-id {
    color: var(--dark-text-light);
    background: var(--dark-bg);
}

/* Пагинация */
.admin-logs-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid var(--light-border);
}

.dark-theme .admin-logs-pagination {
    border-top-color: var(--dark-border);
}

.admin-logs-pagination-info {
    color: var(--text-gray);
    font-size: 0.9rem;
    font-weight: 500;
}

.admin-logs-pagination-controls {
    display: flex;
    gap: 6px;
    align-items: center;
}

.admin-logs-pagination-btn {
    padding: 10px 14px;
    border: 1px solid var(--light-border);
    border-radius: 8px;
    background: var(--light-bg);
    color: var(--text-dark);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
}

.dark-theme .admin-logs-pagination-btn {
    background: var(--dark-bg);
    border-color: var(--dark-border);
    color: var(--dark-text);
}

.admin-logs-pagination-btn:hover {
    border-color: var(--neon-purple);
    color: var(--neon-purple);
    transform: translateY(-2px);
}

.admin-logs-pagination-active {
    background: var(--accent-gradient) !important;
    color: white !important;
    border-color: var(--neon-purple) !important;
}

/* Диаграмма */
.admin-logs-chart-container {
    display: flex;
    gap: 40px;
    align-items: center;
    justify-content: center;
    padding: 30px 0;
    flex-wrap: wrap;
}

.admin-logs-chart-wrapper {
    flex-shrink: 0;
}

.admin-logs-chart-legend {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 250px;
}

.admin-logs-legend-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 12px;
    background: var(--light-bg);
    border: 1px solid var(--light-border);
    transition: var(--transition);
}

.dark-theme .admin-logs-legend-item {
    background: var(--dark-bg);
    border-color: var(--dark-border);
}

.admin-logs-legend-item:hover {
    transform: translateX(8px);
    border-color: var(--neon-purple);
}

.admin-logs-legend-color {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    flex-shrink: 0;
    border: 2px solid white;
}

.dark-theme .admin-logs-legend-color {
    border-color: var(--dark-card);
}

.admin-logs-legend-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-logs-legend-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-dark);
}

.dark-theme .admin-logs-legend-name {
    color: var(--dark-text);
}

.admin-logs-legend-count {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--neon-purple);
    background: var(--light-card);
    padding: 4px 8px;
    border-radius: 6px;
}

.dark-theme .admin-logs-legend-count {
    background: var(--dark-card);
}

/* Статистика диаграммы */
.admin-logs-chart-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 30px;
    padding-top: 25px;
    border-top: 1px solid var(--light-border);
}

.dark-theme .admin-logs-chart-stats {
    border-top-color: var(--dark-border);
}

.admin-logs-chart-stat {
    text-align: center;
    padding: 20px;
    background: var(--light-bg);
    border-radius: 12px;
    border: 1px solid var(--light-border);
    transition: var(--transition);
}

.dark-theme .admin-logs-chart-stat {
    background: var(--dark-bg);
    border-color: var(--dark-border);
}

.admin-logs-chart-stat:hover {
    border-color: var(--neon-purple);
    transform: translateY(-3px);
}

.admin-logs-stat-value {
    display: block;
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--text-dark);
    margin-bottom: 8px;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.dark-theme .admin-logs-stat-value {
    color: var(--dark-text);
}

.admin-logs-stat-label {
    font-size: 0.9rem;
    color: var(--text-gray);
    font-weight: 600;
}

.dark-theme .admin-logs-stat-label {
    color: var(--dark-text-light);
}

/* Управление диаграммой */
.admin-logs-chart-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.admin-logs-period-form {
    display: flex;
    align-items: center;
    gap: 12px;
}

.period-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.period-controls span {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.95rem;
    white-space: nowrap;
}

.dark-theme .period-controls span {
    color: var(--dark-text);
}

.period-controls .admin-logs-form-control {
    width: 140px;
}

.period-controls .admin-logs-btn {
    padding: 10px 20px;
    font-size: 0.9rem;
    white-space: nowrap;
}

/* Состояние пустоты */
.admin-logs-empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--text-gray);
}

.admin-logs-empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.admin-logs-empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 12px;
    font-weight: 700;
    color: var(--text-dark);
}

.dark-theme .admin-logs-empty-state h3 {
    color: var(--dark-text);
}

.admin-logs-empty-state p {
    font-size: 1rem;
    margin: 0;
    opacity: 0.7;
}

/* Цвета для диаграммы */
.admin-logs-chart-create { background-color: #2ecc71; }
.admin-logs-chart-update { background-color: #3498db; }
.admin-logs-chart-delete { background-color: #e74c3c; }
.admin-logs-chart-login { background-color: #9b59b6; }
.admin-logs-chart-logout { background-color: #95a5a6; }
.admin-logs-chart-system { background-color: #f39c12; }
.admin-logs-chart-other { background-color: #34495e; }

/* АДАПТИВНОСТЬ ДЛЯ ПЛАНШЕТОВ */
@media (max-width: 1024px) {
    .hero-section {
        margin: 80px 30px 60px !important;
        padding: 0 30px;
    }
    
    .admin-logs-filters-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .admin-logs-chart-container {
        gap: 30px;
    }
    
    .admin-logs-chart-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* АДАПТИВНОСТЬ ДЛЯ ТЕЛЕФОНОВ */
@media (max-width: 768px) {
    .hero-section {
        margin: 70px 20px 40px !important;
        padding: 0 20px;
    }
    
    .hero-title {
        font-size: clamp(2rem, 8vw, 3rem);
        letter-spacing: -1px;
        margin-bottom: 2rem;
    }
    
    .admin-logs-filters-card,
    .admin-logs-dashboard-card {
        padding: 20px;
        border-radius: 16px;
    }
    
    .admin-logs-filters-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .admin-logs-filter-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .admin-logs-btn {
        width: 100%;
        justify-content: center;
    }
    
    .admin-logs-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .admin-logs-sort-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .admin-logs-data-table {
        font-size: 0.85rem;
        min-width: 600px;
    }
    
    .admin-logs-data-table th,
    .admin-logs-data-table td {
        padding: 15px 12px;
    }
    
    .admin-logs-pagination {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .admin-logs-pagination-controls {
        justify-content: center;
    }
    
    .admin-logs-chart-container {
        flex-direction: column;
        gap: 25px;
    }
    
    .admin-logs-chart-stats {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .period-controls {
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    
    .period-controls .admin-logs-form-control {
        width: 100%;
    }
}

/* Мелкие телефоны */
@media (max-width: 480px) {
    .hero-section {
        margin: 60px 15px 30px !important;
        padding: 0 15px;
    }
    
    .admin-logs-filters-card,
    .admin-logs-dashboard-card {
        padding: 18px;
        border-radius: 14px;
    }
    
    .admin-logs-data-table th,
    .admin-logs-data-table td {
        padding: 12px 8px;
    }
    
    .admin-logs-action-badge {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
    
    .admin-logs-chart-wrapper canvas {
        width: 300px !important;
        height: 300px !important;
    }
    
    .admin-logs-empty-state {
        padding: 60px 20px;
    }
    
    .admin-logs-empty-state i {
        font-size: 3rem;
    }
}
</style>
{% endblock %}

{% block skripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка горячей клавиши Ctrl+Delete для быстрого сброса фильтров
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Delete') {
            e.preventDefault();
            console.log('Ctrl+Delete pressed - resetting filters');
            
            const resetButton = document.querySelector('a[href*="action-logs"]');
            if (resetButton) {
                resetButton.style.transform = 'scale(0.95)';
                resetButton.style.boxShadow = '0 0 15px rgba(139, 92, 246, 0.5)';
                setTimeout(() => {
                    resetButton.style.transform = '';
                    resetButton.style.boxShadow = '';
                }, 500);
                
                setTimeout(() => {
                    window.location.href = resetButton.href;
                }, 300);
            } else {
                console.log('Reset button not found');
            }
        }
    });

    // Инициализация круговой диаграммы и статистики при загрузке страницы
    let logsChart = null;
    
    // Цветовая схема для типов действий
    const typeColors = {
        'create': '#2ecc71',
        'update': '#3498db', 
        'delete': '#e74c3c',
        'login': '#9b59b6',
        'logout': '#95a5a6',
        'system': '#f39c12',
        'other': '#34495e'
    };
    
    // Получение данных для диаграммы из Django-контекста
    const chartData = {{ chart_stats|safe }};
    console.log('Данные для диаграммы с сервера:', chartData);
    
    // Функция обновления круговой диаграммы
    function updateChart(data) {
        const ctx = document.getElementById('logsChart');
        
        if (!ctx) {
            console.error('Canvas элемент не найден!');
            return;
        }
        
        const ctx2d = ctx.getContext('2d');
        
        if (logsChart) {
            logsChart.destroy();
        }
        
        const labels = Object.keys(data.types);
        const counts = Object.values(data.types);
        const backgroundColors = labels.map(type => typeColors[type] || typeColors['other']);
        
        console.log('Данные для диаграммы:', { labels, counts, backgroundColors });
        
        // Обработка случая отсутствия данных
        if (labels.length === 0) {
            ctx2d.clearRect(0, 0, ctx.width, ctx.height);
            ctx2d.font = '16px Arial';
            ctx2d.fillStyle = '#666';
            ctx2d.textAlign = 'center';
            ctx2d.fillText('Нет данных для отображения', ctx.width / 2, ctx.height / 2);
            return;
        }
        
        // Создание новой круговой диаграммы с использованием Chart.js
        logsChart = new Chart(ctx2d, {
            type: 'pie',
            data: {
                labels: labels.map(type => {
                    const typeNames = {
                        'create': 'Создание',
                        'update': 'Обновление', 
                        'delete': 'Удаление',
                        'system': 'Система',
                        'other': 'Другие'
                    };
                    return typeNames[type] || type;
                }),
                datasets: [{
                    data: counts,
                    backgroundColor: backgroundColors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        updateLegend(data.types);
        updateStats(data);
    }
    
    // Функция обновления легенды диаграммы
    function updateLegend(types) {
        const legendContainer = document.getElementById('chartLegend');
        if (!legendContainer) {
            console.error('Контейнер легенды не найден!');
            return;
        }
        
        legendContainer.innerHTML = '';
        
        Object.entries(types).forEach(([type, count]) => {
            const typeNames = {
                'create': 'Создание',
                'update': 'Обновление',
                'delete': 'Удаление',
                'system': 'Система',
                'other': 'Другие'
            };
            
            const legendItem = document.createElement('div');
            legendItem.className = 'admin-logs-legend-item';
            legendItem.innerHTML = `
                <div class="admin-logs-legend-color admin-logs-chart-${type}" 
                     style="background-color: ${typeColors[type] || typeColors['other']}"></div>
                <div class="admin-logs-legend-info">
                    <span class="admin-logs-legend-name">${typeNames[type] || type}</span>
                    <span class="admin-logs-legend-count">${count}</span>
                </div>
            `;
            legendContainer.appendChild(legendItem);
        });
    }
    
    // Функция обновления статистических показателей
    function updateStats(data) {
        const totalLogsElement = document.getElementById('totalLogsCount');
        const mostCommonElement = document.getElementById('mostCommonType');
        const leastCommonElement = document.getElementById('leastCommonType');
        
        if (totalLogsElement) totalLogsElement.textContent = data.total;
        
        const types = data.types;
        const entries = Object.entries(types);
        
        if (entries.length > 0) {
            const mostCommon = entries.reduce((a, b) => a[1] > b[1] ? a : b);
            if (mostCommonElement) {
                mostCommonElement.textContent = 
                    mostCommon[0] === 'create' ? 'Создание' :
                    mostCommon[0] === 'update' ? 'Обновление' :
                    mostCommon[0] === 'delete' ? 'Удаление' :
                    mostCommon[0] === 'system' ? 'Система' : 'Другие';
            }
            
            const leastCommon = entries.reduce((a, b) => a[1] < b[1] ? a : b);
            if (leastCommonElement) {
                leastCommonElement.textContent =
                    leastCommon[0] === 'create' ? 'Создание' :
                    leastCommon[0] === 'update' ? 'Обновление' :
                    leastCommon[0] === 'delete' ? 'Удаление' :
                    leastCommon[0] === 'system' ? 'Система' : 'Другие';
            }
        } else {
            if (mostCommonElement) mostCommonElement.textContent = '—';
            if (leastCommonElement) leastCommonElement.textContent = '—';
        }
    }
    
    // Первоначальное построение диаграммы при загрузке страницы
    updateChart(chartData);
    
    // Анимация появления элементов
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Применение анимации ко всем карточкам
    document.querySelectorAll('.admin-logs-dashboard-card, .admin-logs-filters-card').forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1)';
        card.style.transitionDelay = `${index * 0.1}s`;
        observer.observe(card);
    });
});
</script>
{% endblock %}